<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de Gabarito</title>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
body{font-family:Arial;margin:0;background:#111;color:white;text-align:center}
#cameraContainer{position:relative;width:100%;max-width:480px;margin:20px auto}
#video{width:100%;border-radius:10px}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;border:3px solid rgba(255,255,255,0.4);border-radius:10px;pointer-events:none}
#captureBtn{width:80%;max-width:350px;height:70px;background:#28a745;border:none;border-radius:12px;margin-top:20px;color:white;font-size:24px;font-weight:bold;cursor:pointer;z-index:9999;position:relative}
#canvasOutput{margin:20px auto;width:90%;max-width:500px;border:2px solid white;background:black}
#resultado{font-size:24px;margin-top:20px}
</style>
</head>
<body>

<h1>Leitor de Gabarito</h1>

<div id="cameraContainer">
    <video id="video" autoplay playsinline></video>
    <div id="overlay"></div>
</div>

<button id="captureBtn">CAPTURAR</button>

<canvas id="canvasOutput"></canvas>

<div id="resultado"></div>

<script>
let video=document.getElementById("video")
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(stream=>{video.srcObject=stream})

function waitReady(){
    return new Promise(r=>{
        const c=()=>{video.readyState>=2?r():requestAnimationFrame(c)}
        c()
    })
}

const gabarito={}
const letras=["A","B","C","D","E"]
for(let i=1;i<=70;i++){
    gabarito[i]=letras[(i-1)%5]
}

document.getElementById("captureBtn").onclick=async()=>{
    await waitReady()
    let canvas=document.getElementById("canvasOutput")
    let ctx=canvas.getContext("2d")
    canvas.width=video.videoWidth
    canvas.height=video.videoHeight
    ctx.drawImage(video,0,0)

    let src=cv.imread(canvas)
    let gray=new cv.Mat()
    cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY,0)
    cv.GaussianBlur(gray,gray,new cv.Size(5,5),0)

    let thresh=new cv.Mat()
    cv.threshold(gray,thresh,0,255,cv.THRESH_BINARY_INV+cv.THRESH_OTSU)

    let linhas=70
    let colunas=5
    let largura=Math.floor(thresh.cols/colunas)
    let altura=Math.floor(thresh.rows/linhas)

    let respostas={}
    for(let q=1;q<=70;q++){
        let linha=q-1
        let y=linha*altura
        let maiorSoma=0
        let marcada=null

        for(let c=0;c<5;c++){
            let x=c*largura
            let rec=thresh.roi(new cv.Rect(x,y,largura,altura))
            let soma=cv.countNonZero(rec)
            if(soma>maiorSoma){
                maiorSoma=soma
                marcada=letras[c]
            }
            rec.delete()
        }

        respostas[q]=marcada
    }

    let acertos=0
    for(let i=1;i<=70;i++){
        if(respostas[i]===gabarito[i])acertos++
    }

    document.getElementById("resultado").innerHTML=
        "Acertos: "+acertos+" / 70"

    gray.delete()
    thresh.delete()
    src.delete()
}
</script>
</body>
</html>
